---
import styles from './Toc.module.css'
import clsx from "clsx";
import Icon from '@/assets/learn/icon.svg'

interface Props {
	className?: string;
	headings: Array<{
		text: string;
		id: string;
	}>;
}

const { className, headings } = Astro.props;
---

<nav class={clsx(styles.toc, className)} aria-label="Table of contents">
  {headings.length > 0 && (
		<>
			<h2 class={clsx(
        'text__body--14-medium',
        'text__body--14-medium-lg',
        'text__body--14-medium-md',
        styles.tocTitle
      )}>
				<Icon
					width={16}
					height={18}
				/>
				In this article
			</h2>
			<ul class={styles.tocList}>
				{headings.map((heading) => (
					<li class={clsx(
            'text__body--14',
            'text__body--14-lg',
            'text__body--14-md',
            styles.tocItem
          )} data-id={heading.id}>
						<a href={`#${heading.id}`} class={styles.tocLink}>
							{heading.text}
						</a>
					</li>
				))}
			</ul>
		</>
	)}
</nav>

<script is:inline>
	document.addEventListener("DOMContentLoaded", () => {
		const tocLinks = document.querySelectorAll("a[href^='#']");
		const headings = Array.from(document.querySelectorAll("h2, h3, h4, h5, h6[id]")); 

    function setActive(id) {
			document.querySelectorAll("[data-id]").forEach(el => {
				el.classList.toggle(styles.tocItemActive, el.dataset.id === id);
			});
		}

    function getCurrentHeadingId() {
			const scrollY = window.scrollY + 100;
			for (let i = 0; i < headings.length; i++) {
				const current = headings[i];
				const next = headings[i + 1];
				if (!next || (current.offsetTop <= scrollY && next.offsetTop > scrollY)) {
					return current.id;
				}
			}
			return headings.at(-1)?.id || null;
		}
	
    window.addEventListener("scroll", () => {
			const id = getCurrentHeadingId();
			if (id) setActive(id);
		}, { passive: true });

		tocLinks.forEach(link => {
			link.addEventListener("click", e => {
				e.preventDefault();
				const id = link.getAttribute("href").slice(1);
				const target = document.getElementById(id);
				if (target) {
					window.scrollTo({
						top: target.offsetTop - 80,
						behavior: "smooth"
					});
					history.pushState(null, "", `#${id}`);
					setActive(id);
				}
			});
		});

    function checkInitialHash() {
      const id = location.hash?.slice(1);
      const idToActivate = id && document.getElementById(id) ? id : headings[0]?.id;

      if (idToActivate) {
        setTimeout(() => setActive(idToActivate), 100);
      }
    }

    checkInitialHash();   
  })		
</script>
