---
import { ClientRouter } from 'astro:transitions';
import Layout from '@/layouts/Layout.astro';
import Cta from '@/parts/learn/cta/Cta.astro';
import Hero from '@/parts/resources/hero/Hero.astro';
import List from '@/parts/resources/list/List.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

const POSTS_PER_PAGE = 9;

export async function getStaticPaths() {
  const POSTS_PER_PAGE = 9;
	const resources: CollectionEntry<"resources">[] = await getCollection("resources");
  const totalPages = Math.ceil((resources.length - 1) / POSTS_PER_PAGE);
  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: (i + 1).toString() },
  }));
}

const { page } = Astro.params;
const currentPage = parseInt(page || '1') || 1;

const resources = await getCollection("resources", ({ data }) => {
	return true;
});

const sortedResources = resources.sort(
	(a, b) => (b.data.date?.valueOf() || 0) - (a.data.date?.valueOf() || 0)
);

const normalizeToArray = (field: unknown) => {
	if (!field) return [];
	return Array.isArray(field) ? field : [field];
};

const allCategories = [
	...new Set(resources.flatMap((resource) => normalizeToArray(resource.data.categories))),
];

const foundResource = resources.find(resource => resource.slug === "teg-data-sheet");
const featuredResource = foundResource ?? resources[0];

const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const paginatedResources = sortedResources.slice(startIndex, endIndex);
const totalPages = Math.ceil(sortedResources.length / POSTS_PER_PAGE);

if (currentPage && currentPage === 1) {
	return Astro.redirect("/resources");
}
if (currentPage && currentPage === 1) {
	return Astro.redirect("/resources");
}
---

<Layout
	title="Resources"
	description="Browse articles, guides, and more"
	headerClass="nav__with__bg"
	bodyClass="resources-page"
>
  <Hero featuredResource={featuredResource} allCategories={allCategories} currentCategory={undefined} />
  <div data-resources-wrapper class="resources-wrapper">
    <List 
      resources={paginatedResources}
      totalPages={totalPages}
      currentPage={currentPage}
      baseUrl='/resources'
     />
  </div>
  <Cta />

  <Fragment slot="head">
    <ClientRouter />
  </Fragment>
</Layout>
